<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/">
    <style>
        body {
            background-color: red;
        }

        .oculto {
            display: none;
        }

        .cruz {
            height: 150px;
            width: 150px;
        }

        .visible {
            display: block;
        }

        .fotoMulti {
            height: 280px;
            width: 170px;
        }

        ul {
            display: inline;
        }
    </style>
    <script src="./clases/Usuario.js"></script>
    <script src="./clases/Multimedia.js"></script>
    <script>
        esAdmin = false;
        let listaMultimedia = [];
        paginaActualPorCategoria = {};
        const elementosPorPagina = 4;
        let listaCategoria = ["listaUsuario", "Terror", "Ciencia Ficcion", "Comedia", "Animacion"];
        let tipoSeleccionado = "todos";

        function mostrarUsuario() {
            let usuario = JSON.parse(sessionStorage.getItem("usuarioActual"));
            if (usuario.admin == "S") esAdmin = true;
            document.getElementById("nombreUsuario").textContent = `Bienvenido ${usuario.nombre}`;
        }

        function cargarMultimedia() {
            listaMultimedia.push(new Multimedia("peli", "IT", "Stephen King", "Terror", "it.jpg", "https://www.youtube.com/watch?v=_oBZ_zTz0Nw"));
            listaMultimedia.push(new Multimedia("peli", "Alien", "David Fincher", "Terror", "alien.jpg", ""));
            listaMultimedia.push(new Multimedia("peli", "Inactividad Paranormal", "Michael Tiddes", "Comedia", "inact.jpg", ""));
            listaMultimedia.push(new Multimedia("serie", "Cómo conocí a vuestra madre", "Carter Bays Craig Thomas", "Comedia", "madre.jpg", "https://www.youtube.com/watch?v=90OxzHzvWSg"));
        }

        //Funcion que muestra las pelis o series de cuatro en cuatro
        function mostrarMultimediaPorCategoria(lista) {
            let contenedor = document.getElementById("multimedia");
            contenedor.innerHTML = "";
            if (document.getElementById("categoriaSeccion")) document.getElementById("categoriaSeccion").remove();
            listaCategoria.forEach(categoria => {
                let listaMultimediaFiltrada = lista.filter(multi => multi.categoria == categoria && (tipoSeleccionado == "todos" || multi.tipo == tipoSeleccionado));
                if (!(categoria in paginaActualPorCategoria)) {
                    paginaActualPorCategoria[categoria] = 0;
                }
                let inicio = paginaActualPorCategoria[categoria] * elementosPorPagina;
                let fin = inicio + elementosPorPagina;
                let elementosPagina = listaMultimediaFiltrada.slice(inicio, fin);
                if (elementosPagina.length > 0) {
                    let seccionCategoria = `<div id="${categoria}"><h2>${categoria}</h2><ul class="listaMultimedia"><li>`;
                    elementosPagina.forEach(multi => {
                        seccionCategoria += `<img src="./imagenes/${multi.foto}" class="fotoMulti" onclick="mostrarMultiDetalle('${multi.titulo}')">`;
                    })
                    if (esAdmin) {
                        seccionCategoria += `<img src="./imagenes/cruz.png" class="cruz" onclick="anadirMultimedia('${categoria}')">`;
                        seccionCategoria += `<button type="button" onclick="borrarMultimedia('${categoria}')">Borrar</button>`;
                    }
                    seccionCategoria += '<p>';
                    if (paginaActualPorCategoria[categoria] > 0) {
                        seccionCategoria += `<button type="button" onclick="mostrarPaginaAnterior('${categoria}')">Página anterior</button>`;
                    }
                    if (fin < listaMultimediaFiltrada.length) {
                        seccionCategoria += `<button type="button" onclick="mostrarPaginaSiguiente('${categoria}')">Página siguiente</button>`;
                    }
                    seccionCategoria += '</p>';
                    contenedor.insertAdjacentHTML("beforeend", seccionCategoria);
                }
            })
        }
        //Funcion para mostrar solo pelis o series:
        function cambiarTipoMulti(tipo) {
            tipoSeleccionado = tipo;
            paginaActualPorCategoria = {};
            mostrarMultimediaPorCategoria(listaMultimedia);
        }
        //Funciones para moverse de página:
        function mostrarPaginaAnterior(categoria) {
            if (paginaActualPorCategoria[categoria] > 0) {
                paginaActualPorCategoria[categoria]--;
                mostrarMultimediaPorCategoria(listaMultimedia);
            }
        }
        function mostrarPaginaSiguiente(categoria) {
            paginaActualPorCategoria[categoria]++;
            mostrarMultimediaPorCategoria(listaMultimedia);
        }

        //Funcion barra de busqueda
        function filtrarPorTitulo() {
            let tituloBusqueda = document.getElementById("barraDeBusqueda").value;
            if (tituloBusqueda != "") {
                let contenedor = document.getElementById("multimedia");
                contenedor.innerHTML = "";
                var listaMultiFiltrada = listaMultimedia.filter((multi) => multi.titulo.toLocaleLowerCase().includes(tituloBusqueda.toLocaleLowerCase()));
                let contenido = `<ul><li>`;
                let cont = 1;
                listaMultiFiltrada.forEach(multi => {
                    contenido += `<img src="./imagenes/${multi.foto}" class="fotoMulti" onclick="mostrarMultiDetalle('${multi.titulo}')">`;
                    if (cont == 5) {
                        contenido += `<br>`;
                        cont = 0;
                    }
                    cont++;
                })
                contenido += `</li></ul>`;
                contenedor.insertAdjacentHTML("beforeend", contenido);
            } else {
                mostrarMultimediaPorCategoria(listaMultimedia);
            }
        }

        //Funcion categoria
        function filtrarPorCategoria() {
            let categoria = document.getElementById("filtroCategoria").value;
            if (categoria != "todas") {
                let contenedor = document.getElementById("multimedia");
                let cont = 1;
                contenedor.innerHTML = "";
                let contenido = "<ul><li>";
                listaMultimedia.forEach(multi => {
                    if (multi.categoria == categoria && (tipoSeleccionado == "todos" || multi.tipo == tipoSeleccionado)) {
                        contenido += `<img src="./imagenes/${multi.foto}" class="fotoMulti" onclick="mostrarMultiDetalle('${multi.titulo}')">`;
                        if (cont == 5) {
                            contenido += "<br>";
                            cont = 0;
                        }
                        cont++;
                    }
                })
                contenido += `</li></ul>`;
                contenedor.insertAdjacentHTML("beforeend", contenido);
            } else {
                mostrarMultimediaPorCategoria(listaMultimedia);
            }

        }

        //Añadir 
        function anadirMultimedia(categoria) {
            document.getElementById("divMulti").className = "visible";
            document.getElementById("botonGuardar").className = "visible";
            document.getElementById("botonBorrar").className = "oculto";
            document.getElementById("tipoMulti").className = "visible";
            document.getElementById("directorMulti").className = "visible";
            document.getElementById("fotoMulti").className = "visible";
            document.getElementById("trailerMulti").className = "visible";
            document.getElementById("botonGuardar").addEventListener("click", () => {
                let tipo = document.querySelector("input[name='tipoMulti']:checked");
                if (tipo && document.getElementById("nombre").value != "" && document.getElementById("director").value != "" && document.getElementById("trailer").value != "") {
                    listaMultimedia.push(new Multimedia(tipo.value, document.getElementById("nombre").value, document.getElementById("director").value, categoria, document.getElementById("trailer").value))
                    alert('Multimedia añadido');
                    document.getElementById("divMulti").className = "oculto";
                    mostrarMultimediaPorCategoria(listaMultimedia);
                    document.getElementById("nombre").value = "";
                    document.getElementById("director").value = "";
                    document.getElementById("trailer").value = "";
                } else {
                    alert("Debe rellenar todos los datos");
                }
            });
            document.getElementById("botonCancelar").addEventListener("click", () => { document.getElementById("divMulti").className = "oculto"; });
        }
        //Borrar
        function borrarMultimedia(categoria) {
            document.getElementById("divMulti").className = "visible";
            document.getElementById("botonBorrar").className = "visible";
            document.getElementById("botonGuardar").className = "oculto";
            document.getElementById("tipoMulti").className = "oculto";
            document.getElementById("directorMulti").className = "oculto";
            document.getElementById("fotoMulti").className = "oculto";
            document.getElementById("trailerMulti").className = "oculto";
            document.getElementById("botonBorrar").addEventListener("click", () => {
                let titulo = document.getElementById("nombre").value.trim();
                let indice = listaMultimedia.findIndex(serie => serie.titulo.toLowerCase() === titulo.toLowerCase());
                if (indice != -1) {
                    listaMultimedia.splice(indice, 1);
                    mostrarMultimediaPorCategoria(listaMultimedia);
                    alert(`"${titulo}" ha sido eliminada.`);
                    document.getElementById("divMulti").className = "oculto";
                    document.getElementById("nombre").value = "";
                } else {
                    alert("No se encontró ese título");
                }
            });
            document.getElementById("botonCancelar").addEventListener("click", () => { document.getElementById("divMulti").className = "oculto"; });
        }

        //Funcion detalle multimedia
        function mostrarMultiDetalle(titulo) {
            const multiSeleccionada = listaMultimedia.find(multi => multi.titulo === titulo);
            sessionStorage.setItem("listaMulti", JSON.stringify(listaMultimedia));
            if (multiSeleccionada) {
                sessionStorage.setItem("detalleMulti", JSON.stringify(multiSeleccionada));
                location.href = "MultimediaInfo.html";
            }
        }
        //Funcion lista de peliculas del usuario
        function obtenerMultimediaDeUsuario(usuario) {
            const cookies = document.cookie.split(';');
            let multimedias = [];
            cookies.forEach(cookie => {
                let cookieInfo = cookie.trim().split('=');
                let nombreUsuario = cookieInfo[0];
                let multimedia = cookieInfo[1];
                if (nombreUsuario == usuario) {
                    multimedias.push(multimedia);
                }
            });
            multimedias.forEach(titulo => {
                let multimediaExistente = listaMultimedia.find(multi => multi.titulo == titulo && multi.categoria == "listaUsuario");
                if (!multimediaExistente) {
                    let multi = listaMultimedia.find(multi => multi.titulo == titulo);
                    if (multi) {
                        listaMultimedia.push(new Multimedia(multi.tipo, multi.titulo, multi.director, "listaUsuario", multi.foto, multi.trailer));
                    }
                }
            })
            mostrarMultimediaPorCategoria(listaMultimedia);
        }

        window.onload = function () {
            cargarMultimedia();
            mostrarUsuario();
            obtenerMultimediaDeUsuario(JSON.parse(sessionStorage.getItem("usuarioActual")));
        }
    </script>

</head>

<body>
    <nav>
        <ul>
            <li>
                <img src="" id="perfil">
                <p id="nombreUsuario"></p>
            </li>
            <li>
                <input type="text" id="barraDeBusqueda" onkeyup="filtrarPorTitulo()">
            </li>
            <ul>
                <li><a href="#" onclick="cambiarTipoMulti('todos')">Todos</a></li>
                <li><a href="#" onclick="cambiarTipoMulti('peli')">Películas</a></li>
                <li><a href="#" onclick="cambiarTipoMulti('serie')">Series</a></li>
            </ul>
        </ul>

    </nav>
    <!-- Divs que solo se muestra a los admin -->
    <div class="oculto" id="divMulti">
        <p id="tipoMulti">Tipo de multimedia: <input type='radio' name="tipoMulti" value="peli">peli<input type='radio'
                name="tipoMulti" value="serie">serie</p>
        <p>Titulo: <input type="text" id="nombre"></p>
        <p id="directorMulti">Director: <input type="text" id="director"></p>
        <p id="fotoMulti">Foto: <input type="text" id="fotoPeli"></p>
        <p id="trailerMulti">Trailer: <input type="text" id="trailer"></p>
        <button id="botonGuardar">Guardar</button>
        <button id="botonBorrar">Borrar</button>
        <button id="botonCancelar">Cancelar</button>
    </div>
    <p>
        Categorías:
        <select id="filtroCategoria" onchange="filtrarPorCategoria()">
            <option value="todas">Todas</option>
            <option value="Terror">Terror</option>
            <option value="Ciencia Ficcion">Ciencia Ficcion</option>
            <option value="Comedia">Comedia</option>
            <option value="Animacion">Animación</option>
        </select>
    </p>
    <!-- Div pelis y series -->
    <div id="multimedia"></div>
</body>

</html>