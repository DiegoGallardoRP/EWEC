<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./css/">
    <style>
        body {
            background-color: red;
        }

        .oculto {
            display: none;
        }

        .cruz {
            height: 150px;
            width: 150px;
        }

        .visible {
            display: block;
        }

        .fotoPeli {
            height: 280px;
            width: 170px;
        }

        .fotoSerie {
            height: 280px;
            width: 170px;
        }

        ul {
            display: inline;
        }
    </style>
    <script src="./clases/Usuario.js"></script>
    <script src="./clases/Peliculas.js"></script>
    <script src="./clases/Series.js"></script>
    <script>
        //Listas
        var listaDePeliculas = [];
        var listaDeSeries = [];
        //Variables carrusel
        let indicePaginaPelis = 0;
        const pelisPorPagina = 5;
        let indicePaginaSeries = 0;
        const seriesPorPagina = 5;

        function mostrarUsuario() {
            let usuarioGuardado = sessionStorage.getItem("usuarioActual");
            if (usuarioGuardado) {
                let usuario = JSON.parse(usuarioGuardado);
                document.getElementById("nombreUsuario").textContent = "Bienvenido, " + usuario.nombre;
                esAdmin = usuario.admin == "S";
            }

        }

        function cargarPeliculas() {
            listaDePeliculas.push(new Pelicula("IT", "Stephen King",
                "Terror", "it.jpg", "https://www.youtube.com/watch?v=_oBZ_zTz0Nw"));
            listaDePeliculas.push(new Pelicula("Alien", "David Fincher",
                "Terror", "alien.jpg", ""));
            listaDePeliculas.push(new Pelicula("Inactividad Paranormal", "Michael Tiddes",
                "Comedia", "inact.jpg", ""));
        }

        function cargarSeries() {
            listaDeSeries.push(new Serie("Cómo conocí a vuestra madre", "Carter Bays Craig Thomas",
                "Comedia", "madre.jpg", "https://www.youtube.com/watch?v=90OxzHzvWSg"));
        }

        //Añadir Pelicula
        function anadirPeli(categoria) {
            categoriaNuevaPeli = categoria;
            document.getElementById("divPeli").className = "visible";
            document.getElementById("directorP").className = "visible";
            document.getElementById("fotoP").className = "visible";
            document.getElementById("botonBorrarPeli").className = "oculto";
            document.getElementById("botonGuardarPeli").className = "visible";
        }

        //Añadir Serie
        function anadirSerie(categoria) {
            categoriaNuevaSerie = categoria;
            document.getElementById("divSerie").className = "visible";
            document.getElementById("directorS").className = "visible";
            document.getElementById("fotoS").className = "visible";
            document.getElementById("botonBorrarSerie").className = "oculto";
            document.getElementById("botonGuardarSerie").className = "visible";
        }

        //Funcion pulsar boton guardar peli
        function guardarPeli() {
            let titulo = document.getElementById("nombrePeli").value;
            let director = document.getElementById("directorPeli").value;
            let foto = document.getElementById("fotoPeli").value;

            if (titulo && director && foto) {
                var nuevaPeli = new Pelicula(titulo, director, categoriaNuevaPeli, foto);
                listaDePeliculas.push(nuevaPeli);
                mostrarPeliculasPorCategoria();
                document.getElementById("divPeli").className = "oculto";
                document.getElementById("nombrePeli").value = "";
                document.getElementById("directorPeli").value = "";
                document.getElementById("fotoPeli").value = "";
            } else {
                alert("Por favor, rellena todos los campos");
            }
        }
        //Funcion pulsar boton guardar serie
        function guardarSerie() {
            let titulo = document.getElementById("nombreSerie").value;
            let director = document.getElementById("directorSerie").value;
            let foto = document.getElementById("fotoSerie").value;

            if (titulo && director && foto) {
                var nuevaSerie = new Serie(titulo, director, categoriaNuevaSerie, foto);
                listaDeSeries.push(nuevaSerie);
                mostrarSeriesPorCategoria();
                document.getElementById("divSerie").className = "oculto";
                document.getElementById("nombreSerie").value = "";
                document.getElementById("directorSerie").value = "";
                document.getElementById("fotoSerie").value = "";
            } else {
                alert("Por favor, rellena todos los campos");
            }
        }

        //Borrar peli/serie de una categoría
        function mostrarDivPeli(categoria) {
            categoriaPeli = categoria;
            document.getElementById("divPeli").className = "visible";
            document.getElementById("directorP").className = "oculto";
            document.getElementById("fotoP").className = "oculto";
            document.getElementById("botonGuardarPeli").className = "oculto";
            document.getElementById("botonBorrarPeli").className = "visible";
        }
        function mostrarDivSerie(categoria) {
            categoriaSerie = categoria;
            document.getElementById("divSerie").className = "visible";
            document.getElementById("directorS").className = "oculto";
            document.getElementById("fotoS").className = "oculto";
            document.getElementById("botonGuardarSerie").className = "oculto";
            document.getElementById("botonBorrarSerie").className = "visible";
        }

        function borrarPeli() {
            const titulo = document.getElementById("nombrePeli").value.trim();

            const indice = listaDePeliculas.findIndex(peli => peli.titulo.toLowerCase() === titulo.toLowerCase());
            if (indice !== -1) {
                listaDePeliculas.splice(indice, 1);
                mostrarPeliculasPorCategoria();
                alert(`La película "${titulo}" ha sido eliminada.`);
            } else {
                alert("No se encontró ninguna película con ese título.");
            }

            document.getElementById("nombrePeli").value = "";
            document.getElementById("directorPeli").value = "";
            document.getElementById("fotoPeli").value = "";
            document.getElementById("divPeli").className = "oculto";
        }

        function borrarSerie() {
            const titulo = document.getElementById("nombreSerie").value.trim();

            const indice = listaDeSeries.findIndex(serie => serie.titulo.toLowerCase() === titulo.toLowerCase());
            if (indice !== -1) {
                listaDeSeries.splice(indice, 1);
                mostrarSeriesPorCategoria();
                alert(`La serie "${titulo}" ha sido eliminada.`);
            } else {
                alert("No se encontró ninguna serie con ese título.");
            }

            document.getElementById("nombreSerie").value = "";
            document.getElementById("directorSerie").value = "";
            document.getElementById("fotoSerie").value = "";
            document.getElementById("divSerie").className = "oculto";
        }

        //Método principal pelis
        function mostrarPeliculasPorCategoria() {
            mostrandoPelis = true;
            mostrandoSeries = false;
            let contenedorSeries = document.getElementById("series");
            contenedorSeries.innerHTML = "";

            if (document.getElementById("categoriaSeccion")) {
                document.getElementById("categoriaSeccion").remove();
            }

            const categorias = ["Terror", "Ciencia Ficcion", "Comedia", "Animacion", "Accion"];
            let contenedor = document.getElementById("peliculas");
            contenedor.innerHTML = "";

            categorias.forEach(categoria => {
                let peliculasFiltradas = listaDePeliculas.filter(peli => peli.categoria === categoria);

                if (peliculasFiltradas.length > 0) {
                    const inicio = indicePaginaPelis * pelisPorPagina;
                    const fin = inicio + pelisPorPagina;
                    const peliculasPagina = peliculasFiltradas.slice(inicio, fin);

                    let seccionCategoria = `<div id="categoriaSeccion">
                                    <h2>${categoria}</h2>
                                    <ul class="peliculas-list"><li>`;

                    peliculasPagina.forEach(peli => {
                        seccionCategoria += `<img src="./imagenes/${peli.foto}" alt="${peli.titulo}" class="fotoPeli" onclick="mostrarPeliDetalle('${peli.titulo}')">`
                    });

                    // Añadir la cruz si el usuario es administrador
                    if (esAdmin) {
                        seccionCategoria += `<img src="./imagenes/cruz.png" class="cruz" onclick="anadirPeli('${categoria}')">`;
                        seccionCategoria += `<button type="button" onclick="mostrarDivPeli('${categoria}')">Borrar</button>`;
                    }

                    seccionCategoria += `</li></ul>`;
                    seccionCategoria += `<div class="navegacion">
                                    <button onclick="anteriorPagina('${categoria}')">&lt; Anterior</button>
                                    <button onclick="siguientePagina('${categoria}', ${peliculasFiltradas.length})">Siguiente &gt;</button>
                                 </div>
                                 </div>`;

                    contenedor.insertAdjacentHTML("beforeend", seccionCategoria);
                }
            });
        }
        //Funciones carrusel pelis
        function anteriorPagina(categoria) {
            if (indicePaginaPelis > 0) {
                indicePaginaPelis--;
                mostrarPeliculasPorCategoria();
            }
        }

        function siguientePagina(categoria, totalPeliculas) {
            const totalPaginas = Math.ceil(totalPeliculas / pelisPorPagina);
            if (indicePaginaPelis < totalPaginas - 1) {
                indicePaginaPelis++;
                mostrarPeliculasPorCategoria();
            }
        }
        //Método principal series
        function mostrarSeriesPorCategoria() {
            mostrandoPelis = false;
            mostrandoSeries = true;
            let contenedorPeliculas = document.getElementById("peliculas");
            contenedorPeliculas.innerHTML = "";
            if (document.getElementById("categoriaSeccion")) {
                document.getElementById("categoriaSeccion").remove();
            }
            const categorias = ["Terror", "Ciencia Ficcion", "Comedia", "Animacion", "Accion"];
            let contenedor = document.getElementById("series");
            contenedor.innerHTML = "";

            categorias.forEach(categoria => {
                let seriesFiltradas = listaDeSeries.filter(serie => serie.categoria == categoria);
                if (seriesFiltradas.length > 0) {
                    const inicio = indicePaginaSeries * seriesPorPagina;
                    const fin = inicio + seriesPorPagina;
                    const seriesPagina = seriesFiltradas.slice(inicio, fin);
                    let seccionCategoria = `<div id="categoriaSeccion">
                            <h2>${categoria}</h2>
                            <ul class="series-list"><li>`;
                    seriesPagina.forEach(serie => {
                        seccionCategoria += `<img src="./imagenes/${serie.foto}" alt="${serie.titulo}" class="fotoSerie" onclick="mostrarSerieDetalle('${serie.titulo}')">`
                    });
                    if (esAdmin) {
                        seccionCategoria += `<img src="./imagenes/cruz.png" class="cruz" onclick="anadirSerie('${categoria}')">`;
                        seccionCategoria += `<button type="button" onclick="mostrarDivSerie('${categoria}')">Borrar</button>`;
                    }
                    seccionCategoria += `</li></ul>`;
                    seccionCategoria += `<div class="navegacion">
                            <button onclick="anteriorPaginaSerie('${categoria}')">&lt; Anterior</button>
                            <button onclick="siguientePaginaSerie('${categoria}', ${seriesFiltradas.length})">Siguiente &gt;</button>
                         </div>
                         </div>`;
                    contenedor.insertAdjacentHTML("beforeend", seccionCategoria);
                }
            });
        }

        function mostrarPeliDetalle(titulo) {
            const peliSeleccionada = listaDePeliculas.find(peli => peli.titulo === titulo);
            sessionStorage.setItem("listaPelis",JSON.stringify(listaDePeliculas));
            if (peliSeleccionada) {
                sessionStorage.setItem("detallePeli", JSON.stringify(peliSeleccionada));
                location.href = "Pelicula.html";
            }
        }

        function mostrarSerieDetalle(titulo) {
            const serieSeleccionada = listaDeSeries.find(serie => serie.titulo == titulo);

            if (serieSeleccionada) {
                sessionStorage.setItem("detalleSerie", JSON.stringify(serieSeleccionada));
                location.href = "Serie.html";
            }
        }



        //Carrusel series
        function anteriorPaginaSerie(categoria) {
            if (indicePaginaSeries > 0) {
                indicePaginaSeries--;
                mostrarSeriesPorCategoria();
            }
        }

        function siguientePaginaSerie(categoria, totalSeries) {
            const totalPaginas = Math.ceil(totalSeries / seriesPorPagina);
            if (indicePaginaSeries < totalPaginas - 1) {
                indicePaginaSeries++;
                mostrarSeriesPorCategoria();
            }
        }
        //Métodos que acompañan a la barra de búsqueda
        function mostrarPeliculas(lista) {
            if (document.getElementById("listaPelis")) {
                document.getElementById("listaPelis").remove();
            }
            let contenedor = document.getElementById("peliculas");
            contenedor.innerHTML = "";
            let codigo = `<ul id="listaPelis" class="tabla">`;
            lista.forEach((peli, indice, array) => {
                codigo += `<li><img src="./imagenes/${peli.foto}" class="fotoPeli"> onclick="mostrarPeliDetalle('${peli.titulo}')"</li>`;
            });
            codigo += `</ul>`;
            contenedor.insertAdjacentHTML("beforeend", codigo);
        }

        function mostrarSeries(lista) {
            if (document.getElementById("listaSeries")) {
                document.getElementById("listaSeries").remove();
            }
            let contenedor = document.getElementById("series");
            contenedor.innerHTML = "";
            let codigo = `<ul id="listaSeries" class="tabla">`;
            lista.forEach((serie, indice, array) => {
                codigo += `<li><img src="./imagenes/${serie.foto}" class="fotoSerie"> onclick="mostrarSerieDetalle('${serie.titulo}')"</li>`;
            });
            codigo += `</ul>`;
            contenedor.insertAdjacentHTML("beforeend", codigo);
        }
        //Método barra de búsqueda
        function filtrarPorTitulo() {
            let tituloBusqueda = document.getElementById("barraDeBusqueda").value;
            if (tituloBusqueda == "") {
                mostrarPeliculasPorCategoria();
                mostrarSeriesPorCategoria(); // Asegurarse de mostrar las series también
            } else {
                var listaPelisFiltrada = listaDePeliculas.filter((peli) =>
                    peli.titulo.toLocaleLowerCase().includes(tituloBusqueda.toLocaleLowerCase()));
                var listaSeriesFiltrada = listaDeSeries.filter((serie) =>
                    serie.titulo.toLocaleLowerCase().includes(tituloBusqueda.toLocaleLowerCase()));
                mostrarPeliculas(listaPelisFiltrada);
                mostrarSeries(listaSeriesFiltrada); // Mostrar las series filtradas
            }
        }
        //Método de filtrar por categoria
        function filtrarPorCategoria() {
            if (mostrandoPelis == true) {
                filtrarPeliPorCategoria();
            } else if (mostrandoSeries == true) {
                filtrarSeriePorCategoria();
            }
        }
        //Método filtro pelis
        function filtrarPeliPorCategoria() {
            let categoria = document.getElementById("filtroCategoria").value;
            if (categoria == "todas") {
                mostrarPeliculas(listaDePeliculas);
            } else {
                let listaPelisFiltrada = listaDePeliculas.filter((peli) =>
                    peli.categoria.toLowerCase() == categoria.toLowerCase());
                mostrarPeliculas(listaPelisFiltrada);
            }
        }
        //Método filtro series
        function filtrarSeriePorCategoria() {
            let categoria = document.getElementById("filtroCategoria").value;
            if (categoria == "todas") {
                mostrarSeries(listaDeSeries);
            } else {
                let listaSeriesFiltrada = listaDeSeries.filter((peli) =>
                    peli.categoria.toLowerCase() == categoria.toLowerCase());
                mostrarSeries(listaSeriesFiltrada);
            }
        }

        window.onload = function () {
            cargarPeliculas();
            cargarSeries();
            mostrarUsuario();
            mostrarPeliculasPorCategoria();
        }
    </script>

</head>

<body>
    <nav>
        <ul>
            <li>
                <img src="" id="perfil">
                <img src="">
                <p id="nombreUsuario"></p>
            </li>
            <li>
                <input type="text" id="barraDeBusqueda" onkeyup="filtrarPorTitulo()">
                <img href="" id="lupa">
            </li>
            <ul>
                <li><a href="#" onclick="mostrarPeliculasPorCategoria()">Películas</a></li>
                <li><a href="#" onclick="mostrarSeriesPorCategoria()">Series</a></li>
            </ul>
        </ul>

    </nav>
    <!-- Divs que solo se muestra a los admin -->
    <div class="oculto" id="divPeli">
        <p>Titulo: <input type="text" id="nombrePeli"></p>
        <p id="directorP">Director: <input type="text" id="directorPeli"></p>
        <p id="fotoP">Foto: <input type="text" id="fotoPeli"></p>
        <button onclick="guardarPeli()" id="botonGuardarPeli">Guardar Película</button>
        <button onclick="borrarPeli()" id="botonBorrarPeli">Borrar Película</button>
    </div>
    <div class="oculto" id="divSerie">
        <p>Titulo: <input type="text" id="nombreSerie"></p>
        <p id="directorS">Director: <input type="text" id="directorSerie"></p>
        <p id="fotoS">Foto: <input type="text" id="fotoSerie"></p>
        <button onclick="guardarSerie()" id="botonGuardarSerie">Guardar Serie</button>
        <button onclick="borrarSerie()" id="botonBorrarSerie">Borrar Serie</button>
    </div>
    <p>
        Categorías:
        <select id="filtroCategoria" onchange="filtrarPorCategoria()">
            <option value="todas">Todas</option>
            <option value="Terror">Terror</option>
            <option value="Ciencia Ficcion">Ciencia Ficcion</option>
            <option value="Comedia">Comedia</option>
            <option value="Animacion">Animación</option>
        </select>
    </p>
    <!-- Div pelis y series -->
    <div id="peliculas"></div>
    <div id="series"></div>
</body>

</html>